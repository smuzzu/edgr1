version: '2.1'

jobs:
  build:
    docker:
      - image: cimg/base:2022.05
    steps:
      - checkout
      - run:
          name: Install OpenJDK 17, Maven, Geckodriver and Upgrade Firefox
          command: |
            sudo apt-get update
            sudo apt-get install -y openjdk-17-jdk
            sudo update-alternatives --set java /usr/lib/jvm/java-17-openjdk-amd64/bin/java
            sudo update-alternatives --set javac /usr/lib/jvm/java-17-openjdk-amd64/bin/javac
            sudo apt install maven -y
            sudo apt-get install firefox-geckodriver
            sudo apt upgrade firefox
            wget -q -O - https://dl-ssl.google.com/linux/linux_signing_key.pub | sudo apt-key add - && \ sudo sh -c 'echo "deb [arch=amd64] http://dl.google.com/linux/chrome/deb/ stable main" >> /etc/apt/sources.list.d/google.list' && \
            sudo apt update
            sudo apt-get install -y google-chrome-stable
            CHROMEDRIVER_VERSION=$(curl -s "https://googlechromelabs.github.io/chrome-for-testing/LATEST_RELEASE_STABLE")
            wget -N https://edgedl.me.gvt1.com/edgedl/chrome/chrome-for-testing/${CHROMEDRIVER_VERSION}/linux64/chromedriver-linux64.zip -O /tmp/chromedriver-linux64.zip
            sudo unzip -oj /tmp/chromedriver-linux64.zip -d /usr/local/bin
            sudo chmod +x /usr/local/bin/chromedriver
            sudo apt autoremove
            echo "XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX show versions"
            lsb_release -a
            java -version
            mvn --version
            firefox --version
            google-chrome --version
            geckodriver --version
            chromedriver --version
            which geckodriver
            which chromedriver

      # Run tests using Maven's test or integration-test goal
      - run:
          name: Run Selenium TestNG Tests and send email
          command: |
            chmod +x run.sh
            ./run.sh

workflows:
  version: 2
  build_and_test:
    jobs:
      - build